---
import BaseLayout from "../layouts/BaseLayout.astro";
import SectionTitle from "../components/SectionTitle.astro";
import MarketSummaryCard from "../components/MarketSummaryCard.astro";
import SnapshotList from "../components/SnapshotList.astro";
import LineChart from "../components/charts/LineChart";

import marketData from "../data/market_data.json";
import summary from "../data/summary.json";
import marketsHistory from "../data/history/markets.json";
import { marketDescriptionsBySymbol } from "../data/market_descriptions";

const formatPct = (value: number | null | undefined) => {
  if (typeof value !== "number" || Number.isNaN(value)) {
    return "—";
  }
  const formatter = new Intl.NumberFormat("zh-Hant", {
    maximumFractionDigits: 2,
    minimumFractionDigits: 2
  });
  const prefix = value > 0 ? "+" : "";
  return `${prefix}${formatter.format(value)}%`;
};

const marketsArray = Array.isArray(marketData.markets) ? marketData.markets : [];
const asiaSymbols = ["^TWII", "^HSI", "^N225"];
const asiaMarkets = asiaSymbols
  .map((symbol) => {
    const info = marketsArray.find((item) => item.symbol === symbol) ?? {};
    return {
      symbol,
      name: info.name ?? symbol,
      close: info.close ?? null,
      change: info.daily_change_pct ?? null,
      performance: info.performance ?? {},
      region: info.region ?? marketDescriptionsBySymbol[symbol]?.region
    };
  })
  .filter((item) => item.close !== null);

const asiaSummary = (() => {
  if (!asiaMarkets.length) {
    return "尚未取得亞洲主要指數資料，請稍後再試。";
  }
  const sorted = [...asiaMarkets].sort(
    (a, b) => (b.change ?? Number.NEGATIVE_INFINITY) - (a.change ?? Number.NEGATIVE_INFINITY)
  );
  const best = sorted[0];
  const worst = sorted[sorted.length - 1];
  const avgChange =
    sorted.reduce((acc, item) => acc + (typeof item.change === "number" ? item.change : 0), 0) /
    sorted.length;
  const gainers = sorted.filter((item) => (item.change ?? 0) > 0).length;
  const forexWatch = (marketData.forex ?? []).find((item) => item.pair === "USD/TWD");
  const formatter = new Intl.NumberFormat("zh-Hant", { maximumFractionDigits: 2, minimumFractionDigits: 2 });

  const statements = [
    `今日亞洲指數平均變動 ${formatPct(avgChange)}，${gainers} 檔指數收高。`,
    `領漲指數為 ${best.name}（${formatPct(best.change ?? null)}），${worst.name} 表現相對疲弱（${formatPct(worst.change ?? null)}）。`
  ];

  if (forexWatch && typeof forexWatch.close === "number") {
    statements.push(
      `美元/台幣收在 ${formatter.format(forexWatch.close)}，日變動 ${formatPct(forexWatch.daily_change_pct ?? null)}，顯示資金仍偏向美元資產。`
    );
  }

  return statements.join(" ");
})();

const forexPairs = new Set(["USD/TWD", "USD/HKD", "USD/CNY", "USD/JPY", "USD/KRW"]);
const asiaForex = (marketData.forex ?? [])
  .filter((item) => (item.pair ? forexPairs.has(item.pair) : false))
  .map((item) => ({
    name: item.name ?? item.pair ?? item.symbol ?? "",
    symbol: item.pair ?? item.symbol ?? "",
    price: item.close,
    changePct: item.daily_change_pct,
    link: item.history ? `/watch/${item.history}` : undefined
  }));

const asiaSnapshots = asiaMarkets.map((item) => ({
  name: item.name,
  symbol: item.symbol,
  price: item.close,
  changePct: item.change,
  secondary: item.region ?? undefined,
  link: marketDescriptionsBySymbol[item.symbol]?.slug
    ? `/indices/${marketDescriptionsBySymbol[item.symbol]?.slug}`
    : undefined
}));

const history = marketsHistory as Record<string, { date: string; close: number | null }[]>;
const seriesConfig = asiaSymbols
  .map((symbol) => {
    const meta = marketDescriptionsBySymbol[symbol];
    return meta
      ? { slug: meta.slug, label: meta.name }
      : undefined;
  })
  .filter(Boolean) as { slug: string; label: string }[];

const timeline = seriesConfig.length ? (history[seriesConfig[0].slug] ?? []).map((entry) => entry.date) : [];
const lineData = timeline.map((date, index) => {
  const row: Record<string, string | number | null> = { 日期: date };
  seriesConfig.forEach(({ slug, label }) => {
    row[label] = history[slug]?.[index]?.close ?? null;
  });
  return row;
});

const lineSeries = seriesConfig.map(({ label }, idx) => ({
  dataKey: label,
  color: ["#38bdf8", "#fbbf24", "#a855f7"][idx % 3],
  name: label
}));
---

<BaseLayout title="亞洲市場動態" current="asia">
  <div class="hero">
    <h1>亞洲市場速覽</h1>
    <p>聚焦台股、港股與日股表現，快速掌握區域市場脈動。</p>
  </div>

  <div class="grid two">
    <MarketSummaryCard title="AI 區域觀察" description={asiaSummary} />
    <MarketSummaryCard title="全球敘事回顧" description={summary.regional_trends} />
  </div>

  <section class="grid two">
    <SnapshotList
      title="主要股市收盤"
      subtitle="追蹤台股、港股與日股的最新變化"
      items={asiaSnapshots}
    />
    <SnapshotList
      title="區域匯率"
      subtitle="美元對亞洲主要貨幣的即時波動"
      items={asiaForex}
    />
  </section>

  {lineData.length > 0 && (
    <section class="trend">
      <SectionTitle title="區域動能走勢" subtitle="觀察近幾個交易日的收盤價變化" />
      <LineChart client:load data={lineData} xKey="日期" series={lineSeries} />
    </section>
  )}
</BaseLayout>

<style>
.hero {
  background: rgba(15, 23, 42, 0.6);
  border-radius: 20px;
  padding: 2rem 2.5rem;
  border: 1px solid rgba(148, 163, 184, 0.18);
  backdrop-filter: blur(12px);
  margin-bottom: 2rem;
}

.hero h1 {
  margin: 0;
  color: #f8fafc;
  font-size: 2.25rem;
}

.hero p {
  margin: 1rem 0 0;
  color: #cbd5f5;
  line-height: 1.6;
}

.grid.two {
  display: grid;
  gap: 1.5rem;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  margin-bottom: 2.5rem;
}

.trend {
  margin: 2.5rem 0;
  background: rgba(15, 23, 42, 0.6);
  border-radius: 20px;
  border: 1px solid rgba(148, 163, 184, 0.18);
  padding: 2rem;
}
</style>
