---
import BaseLayout from "../layouts/BaseLayout.astro";
import MarketSummaryCard from "../components/MarketSummaryCard.astro";
import SectionTitle from "../components/SectionTitle.astro";
import PerformanceTable from "../components/PerformanceTable.astro";
import TrendChartGrid from "../components/TrendChartGrid.astro";
import SnapshotGrid from "../components/SnapshotGrid.astro";
import SnapshotList from "../components/SnapshotList.astro";

import marketData from "../data/market_data.json";
import summary from "../data/summary.json";
import { marketDescriptionsBySymbol } from "../data/market_descriptions";
import marketsHistory from "../data/history/markets.json";

const highlightItems = (marketData.highlights ?? []).map((item) => ({
  label: item.label ?? item.name ?? item.symbol ?? "",
  name: item.name ?? item.symbol ?? "",
  symbol: item.symbol ?? "",
  price: item.close,
  changePct: item.daily_change_pct,
  link: item.history ? `/watch/${item.history}` : undefined,
  secondary: item.region
}));

const forexItems = (marketData.forex ?? []).map((item) => ({
  name: item.name ?? item.pair ?? item.symbol ?? "",
  symbol: item.pair ?? item.symbol ?? "",
  price: item.close,
  changePct: item.daily_change_pct,
  link: item.history ? `/watch/${item.history}` : undefined,
  secondary: item.symbol
}));

const commodityItems = (marketData.commodities ?? []).map((item) => ({
  name: item.name ?? item.symbol ?? "",
  symbol: item.symbol ?? "",
  price: item.close,
  changePct: item.daily_change_pct,
  link: item.history ? `/watch/${item.history}` : undefined
}));

const usTechItems = (marketData.us_tech ?? []).map((item) => ({
  name: item.name ?? item.symbol ?? "",
  symbol: item.symbol ?? "",
  price: item.close,
  changePct: item.daily_change_pct,
  link: item.history ? `/watch/${item.history}` : undefined
}));

const cryptoItems = (marketData.crypto ?? []).map((item) => ({
  name: item.name ?? item.symbol ?? "",
  symbol: item.symbol ?? "",
  price: item.close,
  changePct: item.daily_change_pct,
  link: item.history ? `/watch/${item.history}` : undefined
}));

const markets = (marketData.markets ?? []).map((info) => {
  const symbol = info.symbol ?? "";
  const meta = marketDescriptionsBySymbol[symbol];
  return {
    symbol,
    name: info.name ?? meta?.name ?? symbol,
    performance: info.performance ?? {},
    link: meta ? `/indices/${meta.slug}` : undefined
  };
});

const trendSymbols = [
  { slug: "gspc", label: "S&P 500" },
  { slug: "twii", label: "台股加權" },
  { slug: "hsi", label: "恒生" },
  { slug: "n225", label: "日經225" },
  { slug: "stoxx", label: "歐洲600" }
];

const marketHistory = marketsHistory as Record<string, { date: string; close: number | null }[]>;
const trendPalette = ["#38bdf8", "#fbbf24", "#34d399", "#f472b6", "#c084fc"];
const trendCharts = trendSymbols
  .map(({ slug, label }, idx) => {
    const series = marketHistory[slug] ?? [];
    const data = series.map(({ date, close }) => ({ 日期: date, 收盤價: close ?? null }));
    if (!data.length) {
      return undefined;
    }
    return {
      title: label,
      color: trendPalette[idx % trendPalette.length],
      data,
      valueKey: "收盤價",
      valueLabel: label
    };
  })
  .filter(Boolean) as {
  title: string;
  color: string;
  data: Record<string, string | number | null>[];
  valueKey: string;
  valueLabel: string;
}[];

const periodOrder = ["1m", "2m", "3m", "6m", "1y", "3y", "5y"];
const performancePeriods = periodOrder
  .filter((key) => key in (marketData.performance_periods ?? {}))
  .map((key) => ({
    key,
    label: (marketData.performance_periods as Record<string, string>)[key]
  }));
---

<BaseLayout title="全球市場即時脈動" current="home">
  <div class="hero">
    <h1>Global Market Pulse</h1>
    <p>
      每日自動蒐集全球市場、匯率、利率與資金動態，搭配 AI 摘要提供快速洞察。資料更新日期：
      <strong>{marketData.date}</strong>
    </p>
  </div>

  <div class="grid two">
    <MarketSummaryCard title="全球市場總結" description={summary.daily_summary} />
    <MarketSummaryCard title="區域動能觀察" description={summary.regional_trends} />
    <MarketSummaryCard title="資金流向焦點" description={summary.fund_flow} />
  </div>

  <SnapshotGrid
    title="全球焦點觀測"
    subtitle="美元、黃金、原油與各大市場指數的即時日變動，點擊進入可查看歷史走勢"
    items={highlightItems}
  />

  {trendCharts.length > 0 && (
    <section class="trend">
      <SectionTitle title="主要股市趨勢線" subtitle="透過最近幾個交易日的收盤價觀察動能" />
      <TrendChartGrid charts={trendCharts} xKey="日期" />
    </section>
  )}

  <section class="grid two">
    <SnapshotList
      title="外匯觀測"
      subtitle="涵蓋美元、歐元、英鎊、日圓、韓圓、港幣與人民幣對美元的即時變化"
      items={forexItems}
    />
    <SnapshotList
      title="原物料價格"
      subtitle="追蹤黃金、原油與工業金屬的波動"
      items={commodityItems}
    />
  </section>

  <section class="grid two">
    <SnapshotList
      title="美國科技巨頭"
      subtitle="聚焦九大科技龍頭的日內變化"
      items={usTechItems}
    />
    <SnapshotList
      title="加密資產"
      subtitle="比特幣、以太幣與 USDT 穩定幣的價格監控"
      items={cryptoItems}
    />
  </section>

  <section>
    <PerformanceTable
      title="多週期市場表現"
      subtitle="近1個月至5年的報酬率比較，快速掌握長短期趨勢"
      periods={performancePeriods}
      markets={markets}
    />
  </section>
</BaseLayout>

<style>
.hero {
  background: rgba(15, 23, 42, 0.6);
  border-radius: 20px;
  padding: 2rem 2.5rem;
  border: 1px solid rgba(148, 163, 184, 0.18);
  backdrop-filter: blur(12px);
  margin-bottom: 2rem;
}

.hero h1 {
  margin: 0;
  color: #f8fafc;
  font-size: 2.5rem;
}

.hero p {
  margin: 1rem 0 0;
  color: #cbd5f5;
  line-height: 1.6;
}

.hero strong {
  color: #fbbf24;
}

.grid.two {
  display: grid;
  gap: 1.5rem;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  margin-bottom: 2.5rem;
}

.trend {
  margin: 2.5rem 0;
  background: rgba(15, 23, 42, 0.6);
  border-radius: 20px;
  border: 1px solid rgba(148, 163, 184, 0.16);
  padding: 1.5rem;
}

@media (max-width: 768px) {
  .hero {
    padding: 1.5rem;
  }

  .hero h1 {
    font-size: 2rem;
  }

  .grid.two {
    grid-template-columns: 1fr;
  }
}
</style>
